#include  "fuzzy.h"

//模糊表
// FUZTAB SpeedTAB={7,3,
//                  { {0.5,0.3,0.3},  
//                    {0.4,0.2,0.2},  
//                    {0.3,0.2,0.2},
//                    {0.1,0.1,0.1},
//                    {0.2,0.2,0.3},
//                    {0.2,0.2,0.4},
//                    {0.3,0.3,0.5}  },
//                  { { 8, 6, 6},
//                    { 6, 4, 4},
//                    { 3, 3, 3},
//                    { 1, 1, 1},
//                    { 3, 3, 3},
//                    { 4, 4, 6},
//                    { 6, 6, 8} },
//                  { 
//                    {0,0,0},
//                    {0,0,0},
//                    {0,0,0}, 
//                    {0,0,0},  
//                    {0,0,0}, 
//                    {0,0,0},
//                    {0,0,0}  },
//                 {-1.2,-0.5,-0.2,0,0.2,0.5,1.2},   
//                 {-0.15,0,0.15},
// };
FUZTAB SpeedTAB={7,7,
                { {0.6, 0.5, 0.4, 0.3, 0.4, 0.5, 0.6},
                  {0.6, 0.5, 0.3, 0.2, 0.3, 0.5, 0.6},
                  {0.6, 0.5, 0.2, 0.1, 0.2, 0.5, 0.6},
                  {0.6, 0.5, 0.2, 0, 0.2, 0.5, 0.6},
                  {0.6, 0.5, 0.3, 0.1, 0.3, 0.5, 0.6},
                  {0.6, 0.5, 0.4, 0.2, 0.4, 0.5, 0.6},
                  {0.6, 0.5, 0.4, 0.3, 0.4, 0.5, 0.6}  },
                { {0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1},
                  {0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3},
                  {0.6, 0.6, 0.6, 0.6, 0.6, 0.6, 0.6},
                  {0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8},
                  {0.6, 0.6, 0.6, 0.6, 0.6, 0.6, 0.6},
                  {0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3},
                  {0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1}  },
                { {0.3, 0.2, 0.1, 0, 0.1, 0.2, 0.3},
                  {0.3, 0.2, 0.1, 0, 0.1, 0.2, 0.3},
                  {0.3, 0.2, 0.1, 0, 0.1, 0.2, 0.3},
                  {0.3, 0.2, 0.1, 0, 0.1, 0.2, 0.3},
                  {0.3, 0.2, 0.1, 0, 0.1, 0.2, 0.3},
                  {0.3, 0.2, 0.1, 0, 0.1, 0.2, 0.3},
                  {0.3, 0.2, 0.1, 0, 0.1, 0.2, 0.3}  },
                  {-1.2,-0.5,-0.2,0,0.2,0.5,1.2},
                  {-0.2,-0.1,-0.05,0,0.05,0.1,0.2},
};

//FUZTAB SpeedTAB={7,3,
//                 { {0.5,0.3,0.3},
//                   {0.4,0.2,0.2},
//                   {0.2,0.1,0.1},
//                   {0.1,0.1,0.1},
//                   {0.1,0.1,0.2},
//                   {0.2,0.2,0.4},
//                   {0.3,0.3,0.5}  },
//                 { { 8, 6, 6},
//                   { 6, 4, 4},
//                   { 1, 1, 1},
//                   { 0.8, 0.8, 0.8},
//                   { 1, 1, 1},
//                   { 4, 4, 6},
//                   { 6, 6, 8} },
//                 {
//                   {0,0,0},
//                   {0,0,0},
//                   {0,0,0},
//                   {0,0,0},
//                   {0,0,0},
//                   {0,0,0},
//                   {0,0,0}  },
//                {-1.2,-0.5,-0.2,0,0.2,0.5,1.2},
//                {-0.15,0,0.15},
//};

void fuzzyout(FUZTAB *l_tab,float l_EE,float l_EEC,float *pout,float *iout,float *dout)
{
    unsigned char  i,j;
    double psum=0,isum=0,dsum=0;
    float l_BP[10]= {0,0,0,0,0,0,0,0,0,0};
    float l_BD[10]= {0,0,0,0,0,0,0,0,0,0};

    for(i=0; i<l_tab->cntrow; i++)
    {
        if(l_EE<=l_tab->Edot[i])break;
    };
    if(i==0)l_BP[0]=100;
    else if(i==l_tab->cntrow) l_BP[l_tab->cntrow-1]=100;
    else if(i>0 && i<l_tab->cntrow)
    {
        l_BP[i]=(double)100*(l_EE-l_tab->Edot[i-1])/(l_tab->Edot[i]-l_tab->Edot[i-1]);
        l_BP[i-1]=(double)100*(l_tab->Edot[i]-l_EE)/(l_tab->Edot[i]-l_tab->Edot[i-1]);
    }
    for(j=0; j<l_tab->cntcolume; j++)
    {
        if(l_EEC<=l_tab->ECdot[j])break;
    };
    if(j==0)l_BD[0]=100;
    else if(j==l_tab->cntcolume) l_BD[l_tab->cntcolume-1]=100;
    else if(j>0 && j<l_tab->cntcolume)
    {
        l_BD[j]=(double)100*(l_EEC-l_tab->ECdot[j-1])/(l_tab->ECdot[j]-l_tab->ECdot[j-1]);
        l_BD[j-1]=(double)100*(l_tab->ECdot[j]-l_EEC)/(l_tab->ECdot[j]-l_tab->ECdot[j-1]);
    }
    for(i=0; i<l_tab->cntrow; i++)
    {
        for(j=0; j<l_tab->cntcolume; j++)
        {
            psum+=(double)l_BP[i]*l_BD[j]*l_tab->ptab[i][j];
            isum+=(double)l_BP[i]*l_BD[j]*l_tab->itab[i][j];
            dsum+=(double)l_BP[i]*l_BD[j]*l_tab->dtab[i][j];
        }
    }
    *pout=(float)(psum/10000.0f)*1.0f;
    *iout=(float)(isum/10000.0f)*1.0f;
    *dout=(float)(dsum/10000.0f)*0.0f;
}



